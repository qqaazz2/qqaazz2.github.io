<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.94" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•","image":["https://qqaazz2.github.io/assets/images/epubç»“æ„.png \"EPUB ç»“æ„\""],"datePublished":"2025-08-29T00:00:00.000Z","dateModified":"2025-09-02T10:49:36.000Z","author":[{"@type":"Person","name":"qqaazz2"}]}</script><meta property="og:url" content="https://qqaazz2.github.io/posts/a.html"><meta property="og:site_name" content="Qqaazz2's Blog"><meta property="og:title" content="ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•"><meta property="og:description" content="ä½œä¸ºä¸€ä¸ªå°è¯´ç‹‚çƒ­çˆ±å¥½è€…ï¼Œæˆ‘äº²æ‰‹åšäº†ä¸€ä¸ªå±äºè‡ªå·±çš„ EPUB é˜…è¯»å™¨ã€‚æ–‡ç« è®°å½•äº†æˆ‘ä»é›¶å¼€å§‹çš„æ¢ç´¢è¿‡ç¨‹ï¼šè§£æ EPUBã€é‡å†™ CSSã€æ„å»ºèŠ‚ç‚¹æ ‘ã€å®ç°åˆ†é¡µæ¸²æŸ“â€¦â€¦ä¸€è·¯èµ°æ¥æ—¢æœ‰æŒ‘æˆ˜ï¼Œä¹Ÿå……æ»¡ä¹è¶£ã€‚"><meta property="og:type" content="article"><meta property="og:image" content="https://qqaazz2.github.io/assets/images/dreader-logo.png"><meta property="og:locale" content="en-US"><meta property="og:locale:alternate" content="zh-CN"><meta property="og:updated_time" content="2025-09-02T10:49:36.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:src" content="https://qqaazz2.github.io/assets/images/dreader-logo.png"><meta name="twitter:image:alt" content="ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•"><meta property="article:author" content="qqaazz2"><meta property="article:tag" content="Dreader"><meta property="article:tag" content="è‡ªå®šä¹‰æ¸²æŸ“"><meta property="article:tag" content="EPUB"><meta property="article:tag" content="Dart"><meta property="article:tag" content="Flutter"><meta property="article:published_time" content="2025-08-29T00:00:00.000Z"><meta property="article:modified_time" content="2025-09-02T10:49:36.000Z"><link rel="alternate" hreflang="zh-cn" href="https://qqaazz2.github.io/zh/posts/a.html"><link rel="icon" href="/logo.png"><title>ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½• | Qqaazz2's Blog</title><meta name="description" content="ä½œä¸ºä¸€ä¸ªå°è¯´ç‹‚çƒ­çˆ±å¥½è€…ï¼Œæˆ‘äº²æ‰‹åšäº†ä¸€ä¸ªå±äºè‡ªå·±çš„ EPUB é˜…è¯»å™¨ã€‚æ–‡ç« è®°å½•äº†æˆ‘ä»é›¶å¼€å§‹çš„æ¢ç´¢è¿‡ç¨‹ï¼šè§£æ EPUBã€é‡å†™ CSSã€æ„å»ºèŠ‚ç‚¹æ ‘ã€å®ç°åˆ†é¡µæ¸²æŸ“â€¦â€¦ä¸€è·¯èµ°æ¥æ—¢æœ‰æŒ‘æˆ˜ï¼Œä¹Ÿå……æ»¡ä¹è¶£ã€‚">
    <link rel="preload" href="/assets/style-BufAwt8K.css" as="style"><link rel="stylesheet" href="/assets/style-BufAwt8K.css">
    <link rel="modulepreload" href="/assets/app-nNca_EMo.js"><link rel="modulepreload" href="/assets/a.html-T5e2lS_W.js"><link rel="modulepreload" href="/assets/epubç»“æ„-CxhYFyZO.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-By7e8Y2z.js" as="script"><link rel="prefetch" href="/assets/SpringSecurity_AccessDenied.html-BmUdDbWC.js" as="script"><link rel="prefetch" href="/assets/index.html-BUUTeU1w.js" as="script"><link rel="prefetch" href="/assets/SpringSecurity_AccessDenied.html-CJUiJyRa.js" as="script"><link rel="prefetch" href="/assets/a.html-CTpfugRE.js" as="script"><link rel="prefetch" href="/assets/404.html-ahJTL299.js" as="script"><link rel="prefetch" href="/assets/index.html-QDdRETMy.js" as="script"><link rel="prefetch" href="/assets/index.html-BgjrY6_-.js" as="script"><link rel="prefetch" href="/assets/index.html-D4u2qTRj.js" as="script"><link rel="prefetch" href="/assets/index.html-BmoB7bRg.js" as="script"><link rel="prefetch" href="/assets/index.html-CJOETUGa.js" as="script"><link rel="prefetch" href="/assets/index.html-BdrVgn4N.js" as="script"><link rel="prefetch" href="/assets/index.html-yrxJjXiQ.js" as="script"><link rel="prefetch" href="/assets/index.html-D5-nGyHl.js" as="script"><link rel="prefetch" href="/assets/index.html-B_hZiBhr.js" as="script"><link rel="prefetch" href="/assets/index.html-BExKTVD3.js" as="script"><link rel="prefetch" href="/assets/index.html-B5g0iq-u.js" as="script"><link rel="prefetch" href="/assets/index.html-Iwyb660u.js" as="script"><link rel="prefetch" href="/assets/index.html-BLBmlDzl.js" as="script"><link rel="prefetch" href="/assets/index.html-DpHK32Yj.js" as="script"><link rel="prefetch" href="/assets/index.html-C5t1MRg9.js" as="script"><link rel="prefetch" href="/assets/index.html-CEJlfVoC.js" as="script"><link rel="prefetch" href="/assets/index.html-j9pQHBow.js" as="script"><link rel="prefetch" href="/assets/index.html-CeqN4Hav.js" as="script"><link rel="prefetch" href="/assets/index.html-Cyze1ApL.js" as="script"><link rel="prefetch" href="/assets/index.html-CPNqaduJ.js" as="script"><link rel="prefetch" href="/assets/index.html-xq93UM2u.js" as="script"><link rel="prefetch" href="/assets/index.html-BAeWoNRz.js" as="script"><link rel="prefetch" href="/assets/index.html-DTfOHL2E.js" as="script"><link rel="prefetch" href="/assets/index.html--X_XMJDj.js" as="script"><link rel="prefetch" href="/assets/index.html-MsMtdPKT.js" as="script"><link rel="prefetch" href="/assets/index.html-BEFrAvl6.js" as="script"><link rel="prefetch" href="/assets/index.html-C_LA-QnG.js" as="script"><link rel="prefetch" href="/assets/index.html-D7wf6HfU.js" as="script"><link rel="prefetch" href="/assets/index.html-DOBZiPAZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DEdDCT-u.js" as="script"><link rel="prefetch" href="/assets/index.html-D93GK13m.js" as="script"><link rel="prefetch" href="/assets/index.html-DIXZp7I9.js" as="script"><link rel="prefetch" href="/assets/index.html-DbSL79Q7.js" as="script"><link rel="prefetch" href="/assets/index.html-Czio0BWX.js" as="script"><link rel="prefetch" href="/assets/index.html-pZ6kMauE.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-CKV1Bsxh.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="Take me home"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">Qqaazz2&#39;s Blog</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Blog Home"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" sizing="height" height="1em"></iconify-icon><!--]-->Blog Home<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><div class="vp-nav-item"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Select language"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" name="i18n" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/posts/a.html" aria-label="English"><!---->English<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/zh/posts/a.html" aria-label="ç®€ä½“ä¸­æ–‡"><!---->ç®€ä½“ä¸­æ–‡<!----></a></li></ul></button></div></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/qqaazz2/qqaazz2.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="Blog Home"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Blog Home<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><iconify-icon class="vp-icon" icon="fa6-solid:book" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">article</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/posts/SpringSecurity_AccessDenied.html" aria-label="Spring Security å¼‚æ­¥è¸©å‘è®°ï¼šAccess Denied"><!---->Spring Security å¼‚æ­¥è¸©å‘è®°ï¼šAccess Denied<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/posts/a.html" aria-label="ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•"><!---->ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/intro.html" aria-label="/intro.html"><!---->/intro.html<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><div class="page-cover"><img src="/assets/images/dreader-logo.png" alt no-view></div><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•</h1><div class="page-info"><span class="page-author-info" aria-label="AuthorğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">qqaazz2</span></span><span property="author" content="qqaazz2"></span></span><span class="page-original-info">Original</span><span class="page-date-info" aria-label="Writing DateğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">8/29/25</span><meta property="datePublished" content="2025-08-29T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 24 min</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="CategoryğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color3 clickable" role="navigation">Dreader</span><!--]--><meta property="articleSection" content="Dreader"></span><span class="page-tag-info" aria-label="TagğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color3 clickable" role="navigation">Flutter</span><span class="page-tag-item color8 clickable" role="navigation">Dart</span><span class="page-tag-item color4 clickable" role="navigation">EPUB</span><span class="page-tag-item color0 clickable" role="navigation">è‡ªå®šä¹‰æ¸²æŸ“</span><span class="page-tag-item color3 clickable" role="navigation">Dreader</span><!--]--><meta property="keywords" content="Flutter,Dart,EPUB,è‡ªå®šä¹‰æ¸²æŸ“,Dreader"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><blockquote><p><strong>é¡¹ç›®æºç åœ°å€</strong>ï¼š<a href="https://github.com/qqaazz2/dreader" target="_blank" rel="noopener noreferrer">https://github.com/qqaazz2/dreader</a></p></blockquote><h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€"><span>å‰è¨€</span></a></h2><p>ä½œä¸ºä¸€ä¸ªå°è¯´çˆ±å¥½è€…ï¼Œé˜…è¯»å¯¹æˆ‘æ¥è¯´ä¸ä»…æ˜¯æ‰“å‘æ—¶é—´ï¼Œæ›´æ˜¯ä¸€ç§èƒ½è®©æˆ‘æ²‰æµ¸åœ¨å¦ä¸€ä¸ªä¸–ç•Œé‡Œçš„æ–¹å¼ã€‚æ¯æ¬¡ç¿»é¡µï¼Œéƒ½åƒæ˜¯çŸ­æš‚åœ°é€ƒç¦»ç°å®ï¼ŒæŠ•å…¥åˆ°æ–‡å­—ç¼–ç»‡çš„ä¸–ç•Œé‡Œã€‚</p><p>æ­£å› ä¸ºè¿™æ ·ï¼Œæˆ‘çªç„¶æœ‰äº†ä¸ªæƒ³æ³•ï¼š<strong>ä¸ºä»€ä¹ˆä¸è‡ªå·±åŠ¨æ‰‹åšä¸€ä¸ªä¸“å±çš„ EPUB é˜…è¯»å™¨å‘¢ï¼Ÿ</strong></p><p>è¿™æ ·ä¸ä»…èƒ½é¡ºä¾¿æ·±å…¥ç ”ç©¶ä¸€ä¸‹ Flutter çš„æ¸²æŸ“æœºåˆ¶ï¼Œè¿˜èƒ½ç»™è‡ªå·±æ‰“é€ ä¸€ä¸ªå®Œå…¨å±äºæˆ‘çš„é˜…è¯»ç©ºé—´ã€‚å¸¦ç€è¿™æ ·çš„å¿µå¤´ï¼Œæˆ‘å°±å¼€å§‹äº†è¿™æ®µæ—¢æœ‰æŒ‘æˆ˜åˆå……æ»¡ä¹è¶£çš„æ—…ç¨‹ã€‚</p><p>ä»æœ€å¼€å§‹çš„ä¸€ä¸ªå°å°å¿µå¤´ï¼Œåˆ°ä¸€æ­¥æ­¥æŠŠåŠŸèƒ½åšå‡ºæ¥ï¼Œæœ€ç»ˆæœ‰äº† DReader â€”â€” ä¸€ä¸ªç®€æ˜“çš„ EPUB é˜…è¯»å™¨ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œå®ƒä¸ä»…ä»…æ˜¯ä¸ªé¡¹ç›®ï¼Œæ›´æ˜¯æˆ‘æŠŠå¯¹é˜…è¯»çš„çƒ­çˆ±å’ŒæŠ€æœ¯æ¢ç´¢ç»“åˆåœ¨ä¸€èµ·çš„æˆæœã€‚</p><h2 id="æŠ€æœ¯é€‰å‹" tabindex="-1"><a class="header-anchor" href="#æŠ€æœ¯é€‰å‹"><span>æŠ€æœ¯é€‰å‹</span></a></h2><p>åœ¨é¡¹ç›®åˆæœŸï¼Œæˆ‘å°è¯•äº†å¤šç§é’ˆå¯¹è¯¥EPUBä¹¦ç±çš„æ¸²æŸ“æ–¹æ¡ˆï¼Œæ¯ç§æ–¹æ¡ˆéƒ½å…·å¤‡å…¶ç‹¬ç‰¹çš„ä¼˜åŠ¿ã€‚</p><h3 id="æ–¹æ¡ˆä¸€-æå–æ–‡æœ¬-è‡ªè¡Œæ’ç‰ˆ" tabindex="-1"><a class="header-anchor" href="#æ–¹æ¡ˆä¸€-æå–æ–‡æœ¬-è‡ªè¡Œæ’ç‰ˆ"><span>æ–¹æ¡ˆä¸€ï¼šæå–æ–‡æœ¬ï¼Œè‡ªè¡Œæ’ç‰ˆ</span></a></h3><ul><li>æˆ‘çš„åˆè¡·æ˜¯å°† EPUB æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–‡æœ¬æå–å‡ºæ¥ï¼Œäº¤ç”± Flutter é‡æ–°è®¡ç®—æ’ç‰ˆï¼Œå¹¶å¯¹å›¾ç‰‡è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œä»è€Œå®ç°é˜…è¯»å™¨çš„æ¸²æŸ“ã€‚ç„¶è€Œï¼Œåœ¨å®é™…å®ç°ä¸­å´é‡åˆ°äº†è®¸å¤šæ£˜æ‰‹é—®é¢˜ï¼šæ’ç‰ˆæ•ˆæœååˆ†æ€ªå¼‚ï¼Œå¯¹äºéƒ¨åˆ†ç‰¹æ®Šæ ‡ç­¾æ— æ³•å¾ˆå¥½åœ°å…¼å®¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ³¨é‡Šå›¾æ ‡å¯èƒ½ä¼šè¢«æ¸²æŸ“æˆå æ®æ•´æ•´ä¸€é¡µã€‚æœ€ç»ˆï¼Œè¿™ç§â€œè‡ªæ’ç‰ˆâ€æ–¹æ¡ˆå› ä½“éªŒä¸ä½³è€Œè¢«å¼ƒç”¨ã€‚</li></ul><h3 id="æ–¹æ¡ˆäºŒ-webview-æ¸²æŸ“" tabindex="-1"><a class="header-anchor" href="#æ–¹æ¡ˆäºŒ-webview-æ¸²æŸ“"><span>æ–¹æ¡ˆäºŒï¼šWebView æ¸²æŸ“</span></a></h3><ul><li>ç”±äº EPUB æœ¬è´¨ä¸Šæ˜¯ç”±ä¸€ç»„ XHTML æ–‡ä»¶æ„æˆï¼Œç›´æ¥ä½¿ç”¨ WebView æ¥æ¸²æŸ“æ— ç–‘æ˜¯æœ€ç®€å•ã€æœ€è¿˜åŸåŸå§‹æ ·å¼çš„æ–¹å¼ã€‚è¿™ä¸€æ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºå®ç°æˆæœ¬ä½ï¼Œèƒ½æœ€å¤§ç¨‹åº¦ä¿æŒåŸä¹¦çš„æ ·å¼å’Œæ’ç‰ˆã€‚ä½†å®ƒçš„ç¼ºé™·ä¹Ÿååˆ†æ˜æ˜¾ï¼šHTML çš„æ¸²æŸ“æ˜¯è‡ªä¸Šè€Œä¸‹çš„çº¿æ€§å¸ƒå±€ï¼Œè¦åœ¨ WebView ä¸­å®ç°åŸç”Ÿèˆ¬çš„å·¦å³ç¿»é¡µæ•ˆæœå¹¶ä¸å®¹æ˜“ã€‚æƒè¡¡å†ä¸‰ï¼Œè¿™ä¸€æ–¹æ¡ˆä¹Ÿè¢«æˆ‘æ”¾å¼ƒ</li></ul><h3 id="æ–¹æ¡ˆä¸‰-åŸºäº-canvas-çš„è‡ªç ”æ¸²æŸ“å¼•æ“-æœ€ç»ˆæ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#æ–¹æ¡ˆä¸‰-åŸºäº-canvas-çš„è‡ªç ”æ¸²æŸ“å¼•æ“-æœ€ç»ˆæ–¹æ¡ˆ"><span>æ–¹æ¡ˆä¸‰ï¼šåŸºäº Canvas çš„è‡ªç ”æ¸²æŸ“å¼•æ“ï¼ˆæœ€ç»ˆæ–¹æ¡ˆï¼‰</span></a></h3><ul><li>è¿™æ˜¯ DReader æœ€ç»ˆé‡‡ç”¨çš„å®ç°æ–¹å¼ã€‚è¯¥æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè§£æ EPUB æ–‡ä»¶ä¸­çš„ XHTMLã€CSSã€å›¾ç‰‡ç­‰èµ„æºï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸º Flutter å¯æ¸²æŸ“çš„æ§ä»¶ï¼Œç›¸å½“äºåœ¨ Flutter çš„ç”»å¸ƒä¸Šâ€œé‡æ–°ç»˜åˆ¶â€é¡µé¢ã€‚ç›¸è¾ƒäº WebViewï¼Œè¿™ç§æ–¹å¼è™½ç„¶å®ç°éš¾åº¦æ›´é«˜ï¼Œä½†ä¼˜åŠ¿åœ¨äºé«˜åº¦å¯æ§ä¸å¯å®šåˆ¶åŒ–ã€‚æ¯”å¦‚æˆ‘æœ€å–œæ¬¢çš„å·¦å³ç¿»é¡µçš„åŠŸèƒ½ï¼Œåœ¨è‡ªç»˜åˆ¶çš„æ¨¡å¼ä¸‹å°±èƒ½éå¸¸è‡ªç„¶åœ°å®ç°ã€‚</li></ul><h2 id="epub-æ–‡ä»¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#epub-æ–‡ä»¶ç»“æ„"><span>EPUB æ–‡ä»¶ç»“æ„</span></a></h2><p>åœ¨å®ç°é¡¹ç›®çš„å‰æä¸‹é¦–å…ˆéœ€è¦äº†è§£çš„å°±æ˜¯è¿™ä¸ª EPUB æ–‡ä»¶åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼ŒEPUB æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼ˆåç¼€å .epubï¼‰ï¼Œå†…éƒ¨åŒ…å«ä¹¦ç±çš„æ‰€æœ‰å†…å®¹å’Œèµ„æºã€‚å…¶ç›®å½•ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤º</p><figure><img src="/assets/images/epub%E7%BB%93%E6%9E%84.png" alt="è¿™æ˜¯å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>EPUB ç»“æ„</figcaption></figure><h3 id="å…³é”®çš„æ–‡ä»¶è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#å…³é”®çš„æ–‡ä»¶è¯´æ˜"><span>å…³é”®çš„æ–‡ä»¶è¯´æ˜</span></a></h3><ul><li><strong><code>mimetype</code></strong> ï¼šå¿…é¡»å­˜åœ¨ï¼Œä¸”å†…å®¹å›ºå®šä¸ºapplication/epub+zipã€‚ç”¨äºå£°æ˜æ–‡ä»¶æ˜¯ EPUB æ ¼å¼ã€‚</li><li><strong><code>META-INF/container.xml</code></strong> ï¼šæŒ‡å®šä¹¦ç±çš„å…¥å£ .opf æ–‡ä»¶è·¯å¾„</li><li><strong><code>*.opf</code></strong> ï¼šEPUB çš„æ ¸å¿ƒæ¸…å•æ–‡ä»¶ï¼Œå®šä¹‰äº† èµ„æºæ–‡ä»¶ã€ç« èŠ‚é¡ºåºã€å…ƒä¿¡æ¯</li><li><strong><code>*.xhtml</code></strong> ï¼šä¹¦ç±çš„å®é™…æ­£æ–‡ï¼Œæ¯ä¸€ç« é€šå¸¸æ˜¯ä¸€ä¸ª XHTML æ–‡ä»¶ã€‚</li><li><strong><code>*.css</code></strong> ï¼šå®šä¹‰ä¹¦ç±çš„æ’ç‰ˆå’Œæ ·å¼</li><li><strong><code>toc.ncx / nav.xhtml</code></strong> ï¼šç›®å½•æ–‡ä»¶ï¼ˆEPUB 2 ç”¨ toc.ncxï¼ŒEPUB 3 ç”¨ nav.xhtmlï¼‰ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨äºç”Ÿæˆç« èŠ‚å¯¼èˆª</li></ul><h3 id="epub-æ–‡ä»¶å·¥ä½œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#epub-æ–‡ä»¶å·¥ä½œæµç¨‹"><span>EPUB æ–‡ä»¶å·¥ä½œæµç¨‹</span></a></h3><ol><li><p><strong><code>container.xml</code></strong><br> å‘Šè¯‰é˜…è¯»å™¨ <strong><code>.opf</code> æ–‡ä»¶çš„ä½ç½®</strong></p></li><li><p><strong><code>.opf</code></strong><br> å®šä¹‰ <strong>ä¹¦ç±çš„å…ƒä¿¡æ¯ã€èµ„æºæ¸…å•å’Œé˜…è¯»é¡ºåº</strong></p></li><li><p><strong><code>.xhtml</code> + <code>.css</code> + å›¾ç‰‡</strong><br> æ„æˆä¹¦ç±çš„ <strong>å®é™…å±•ç¤ºå†…å®¹</strong></p></li></ol><h2 id="epub-æ–‡ä»¶è§£æ" tabindex="-1"><a class="header-anchor" href="#epub-æ–‡ä»¶è§£æ"><span>EPUB æ–‡ä»¶è§£æ</span></a></h2><p>è¦å®ç°é˜…è¯»åŠŸèƒ½ï¼Œé¦–è¦æ­¥éª¤æ˜¯å°† EPUB æ–‡ä»¶è§£æå‡ºæ¥ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦å°† EPUB å†…éƒ¨çš„ <strong>XHTMLã€CSS</strong> ç­‰æ–‡ä»¶ï¼Œé€šè¿‡ Dart è¯­è¨€è½¬æ¢ä¸ºç¨‹åºå¯ä»¥ç†è§£çš„å…ƒæ•°æ®ã€‚</p><ol><li><p><strong>è¯»å–å¹¶è§£å‹ EPUB æ–‡ä»¶</strong></p><p>éµå¾ª EPUB çš„æ ‡å‡†å·¥ä½œæµç¨‹ï¼Œè§£æçš„è·å–åˆ°EPUBæ–‡ä»¶ä¸­çš„æ‰€æœ‰çš„æ–‡ä»¶ã€‚</p><p>å…·ä½“çš„å®ç°æ–¹å¼æ˜¯ï¼šé¦–å…ˆå°†æ•´ä¸ª EPUB æ–‡ä»¶ï¼ˆæœ¬è´¨æ˜¯ ZIP å‹ç¼©åŒ…ï¼‰è§£å‹ï¼Œç„¶åå°†å†…éƒ¨æ‰€æœ‰æ–‡ä»¶å­˜å…¥ä¸€ä¸ª <code>Map</code> ä¸­ã€‚åœ¨è¿™ä¸ª <code>Map</code> é‡Œï¼Œ<code>key</code> æ˜¯æ–‡ä»¶åï¼ˆä¾‹å¦‚ <code>META-INF/container.xml</code>ï¼‰ï¼Œ<code>value</code> åˆ™æ˜¯å¯¹åº”æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚</p><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯EPUBæ–‡ä»¶çš„äºŒè¿›åˆ¶æµ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Future</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt;&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">extractEpubFromBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; epubBytes) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> archive </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ZipDecoder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decodeBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(epubBytes);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> extractedFiles </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> file </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> archive) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (file.isFile) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      extractedFiles[file.name] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> file.content </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> extractedFiles;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></li><li><p><strong>è§£æ META-INF/container.xml è·å– .opf æ–‡ä»¶</strong></p><p>å¯¹äºæ‹¿åˆ°çš„ <code>Map</code> ä¸­å»æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ <code>META-INF/container.xml</code> å¹¶ä½¿ç”¨ <a href="https://pub.dev/packages/xml" target="_blank" rel="noopener noreferrer"><code>XmlDocument</code></a> å»è§£æè¿™ä¸ªxmlæ–‡ä»¶æ‹¿åˆ° <code>rootfiles</code> æ ‡ç­¾çš„ <code>full-path</code> å±æ€§ä»¥è·å– <code>.opf</code> æ–‡ä»¶çš„ä½ç½®</p><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯åœ¨è§£æEPUBæ–‡ä»¶æ—¶è·å–åˆ°çš„æ‰€æœ‰æ–‡ä»¶èµ„æº</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> locateOpfFile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; files) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> containerPath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;META-INF/container.xml&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">files.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">containsKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(containerPath)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;container.xml not found!&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> containerContent </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> utf8.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(files[containerPath]</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> document </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> XmlDocument</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(containerContent);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è§£æcontainer.xml</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //æ‹¿åˆ°å¯¹åº”çš„rootfileæ ‡ç­¾ä¸‹çš„full-pathå±æ€§çš„å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> opfPath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> document.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">findAllElements</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;rootfile&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).first.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAttribute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;full-path&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (opfPath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;OPF file path not found in container.xml!&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //è¿™é‡Œåœ¨è·å–è¿™ä¸ªopfçš„çˆ¶çº§æ–‡ä»¶å¤¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    _opfDir </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> opfPath.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">contains</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">        ?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> opfPath.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">substring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, opfPath.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lastIndexOf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">        :</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> opfPath;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></li><li><p><strong>è§£æ .opf æ–‡ä»¶ä»¥è·å–èµ„æºæ–‡ä»¶åŠç« èŠ‚é¡ºåº</strong></p><p>æ‹¿åˆ°å¯¹åº”çš„ <code>.opf</code> æ–‡ä»¶åå°±å¯ä»¥å¤„ç†å‡ºæ¥è¿™äº›èµ„æºæ–‡ä»¶ä»¥åŠç« èŠ‚çš„é¡ºåºäº†</p><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯åœ¨è§£æå¤„ç†å¥½çš„opfæ–‡ä»¶çš„å†…å®¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">dynamic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseOpf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> opfContent) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> document </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> XmlDocument</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(opfContent);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // è§£æ manifest</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; manifest </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {};</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> document.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">findAllElements</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;item&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAttribute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;id&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> href </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAttribute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;href&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> href </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                manifest[id] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> href;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // è§£æ spine</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> spine </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> document</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">findAllElements</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;itemref&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((itemRef) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> itemRef.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAttribute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;idref&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                })</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((idref) =&gt; idref </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;manifest&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> manifest, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;spine&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> spine};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></li><li><p><strong>ç¼–æ’å¹¶è¿”å›èµ„æºæ–‡ä»¶</strong></p><p>æŒ‰ç…§ <code>spine</code> ä¸­çš„å¾ªåºæ’å¥½ç« èŠ‚ï¼Œå¹¶å°†å…¶è¿”å›å‡ºæ¥</p><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯å¤„ç†å¥½çš„manifest(èµ„æºæ–‡ä»¶)å’Œspine(æ’åº)</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">readChapters</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; files,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; manifest,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">?&gt; spine,) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> chapters </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idref </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> spine) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> relativePath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> manifest[idref];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (relativePath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                throw</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Warning: idref </span><span style="--shiki-light:#50A14F;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">idref</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> not found in manifest.&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            relativePath </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Uri</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decodeFull</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(relativePath);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> chapterFile </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> files[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">_opfDir</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span><span style="--shiki-light:#50A14F;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">relativePath</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (chapterFile </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                throw</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Warning: Chapter file not found: </span><span style="--shiki-light:#50A14F;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">relativePath</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> content </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> utf8.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(chapterFile);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            chapters.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(content);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> chapters;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></li></ol><h2 id="css-æ–‡ä»¶è§£æä¸æ ·å¼é‡å†™" tabindex="-1"><a class="header-anchor" href="#css-æ–‡ä»¶è§£æä¸æ ·å¼é‡å†™"><span>CSS æ–‡ä»¶è§£æä¸æ ·å¼é‡å†™</span></a></h2><p>åœ¨æˆåŠŸè§£æå¹¶æå–å‡º EPUB æ–‡ä»¶çš„åŸºç¡€èµ„æºä¹‹åï¼Œæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯å¯¹ <strong>CSS æ–‡ä»¶</strong> çš„å¤„ç†ã€‚<br> ä¼—æ‰€å‘¨çŸ¥ï¼ŒEPUB æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç»„ XHTML + CSS çš„ç»„åˆæ–‡ä»¶ï¼Œå› æ­¤è¦åœ¨ Flutter ä¸­å¤ç° EPUB çš„æ ·å¼æ•ˆæœï¼Œå°±å¿…é¡»è§£å†³ <strong>å¦‚ä½•è®© Flutter æ­£ç¡®ç†è§£å¹¶æ¸²æŸ“ CSS æ ·å¼</strong> è¿™ä¸ªé—®é¢˜ã€‚</p><p>åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ <a href="https://pub.dev/packages/csslib" target="_blank" rel="noopener noreferrer"><code>csslib</code></a> è¿™ä¸ªåº“æ¥è§£æ CSSã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©æˆ‘æŠŠ EPUB ä¸­çš„ CSS æ–‡ä»¶è§£æä¸º Dart ç»“æ„åŒ–æ•°æ®ï¼Œæ¥ç€æˆ‘å†å°†å…¶è§„åˆ™<strong>é‡å†™ä¸º Flutter å¯ä½¿ç”¨çš„ <code>TextStyle</code></strong>ï¼Œä»¥å®ç°æ ·å¼çš„æ˜ å°„ã€‚</p><p>ä¸ºäº†æ¨¡æ‹Ÿ CSS çš„ä¼˜å…ˆçº§æœºåˆ¶ï¼Œæˆ‘è®¾è®¡äº†å››ç±»æ ·å¼é›†åˆï¼š</p><ul><li><code>tagStyles</code> â€”â€” é’ˆå¯¹æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ <code>p</code>ã€<code>h1</code></li><li><code>classStyles</code> â€”â€” é’ˆå¯¹ç±»é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ <code>.highlight</code></li><li><code>idStyles</code> â€”â€” é’ˆå¯¹ ID é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ <code>#title</code></li><li><code>complexStyles</code> â€”â€” é’ˆå¯¹å¤åˆé€‰æ‹©å™¨ï¼Œä¾‹å¦‚ <code>p.note</code></li></ul><p>é€šè¿‡è¿™å‡ ç±»æ ·å¼é›†åˆï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ã€Œæ ·å¼å±‚å ä¸è¦†ç›–ã€é€»è¾‘ï¼Œä»è€Œä¿è¯ä¸åŒæ¥æºçš„æ ·å¼ä¸ä¼šäº’ç›¸å†²çªã€‚</p><p>ç›®å‰é¡¹ç›®åªå®ç°äº†å¯¹ EPUB ä¸­<strong>å¸¸ç”¨ CSS å±æ€§</strong>çš„æ”¯æŒï¼Œä¾‹å¦‚ï¼š</p><ul><li><code>margin</code> â€”â€” å¤–è¾¹è·</li><li><code>padding</code> â€”â€” å†…è¾¹è·</li><li><code>line-height</code> â€”â€” è¡Œé«˜</li><li><code>font-size</code> â€”â€” å­—ä½“å¤§å°</li></ul><p>æ¢å¥è¯è¯´ç°åœ¨çš„æ ·å¼ç³»ç»Ÿè¿˜ä¸è¶³ä»¥å®Œå…¨è¿˜åŸ EPUB çš„æ’ç‰ˆæ•ˆæœï¼Œä½†å·²ç»èƒ½åº”ä»˜å¤§å¤šæ•°åŸºç¡€çš„é˜…è¯»éœ€æ±‚ã€‚</p><p>ğŸ“Œ å…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥åœ¨æºç æ–‡ä»¶ <strong><code>CssToTextstyle.dart</code></strong> ä¸­æŸ¥çœ‹ã€‚</p><h2 id="è§£ædom-è·å–èŠ‚ç‚¹æ ‘" tabindex="-1"><a class="header-anchor" href="#è§£ædom-è·å–èŠ‚ç‚¹æ ‘"><span>è§£æDOM è·å–èŠ‚ç‚¹æ ‘</span></a></h2><p>åœ¨å®Œæˆå¯¹æ‰€æœ‰ <strong>CSS æ–‡ä»¶</strong> çš„è§£æä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥ <strong>XHTML æ–‡ä»¶çš„è§£æé˜¶æ®µ</strong>ã€‚<br> ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€ä¸ª HTML æ–‡ä»¶é€šå¸¸ç”±ä¸€ä¸ª <code>&lt;body&gt;</code> èŠ‚ç‚¹åŒ…è£¹ä½å…¶å†…éƒ¨çš„æ‰€æœ‰ DOMï¼Œè€Œ DOM ä¹‹é—´åˆå¯èƒ½å­˜åœ¨åµŒå¥—å…³ç³»ã€‚è¿™ç§åµŒå¥—å¼çš„ DOM ç»“æ„ï¼Œæœ€ç»ˆæ„æˆäº†æˆ‘ä»¬æ—¥å¸¸çœ‹åˆ°çš„ç½‘é¡µå¸ƒå±€ã€‚</p><p>å› æ­¤ï¼Œåœ¨è§£æ XHTML æ–‡ä»¶æ—¶ï¼Œæˆ‘åŒæ ·ä¿ç•™äº†è¿™ç§ <strong>åµŒå¥— DOM çš„å±‚çº§ç»“æ„</strong>ï¼Œä»¥ä¾¿åç»­åœ¨æ¸²æŸ“é˜¶æ®µèƒ½å¤Ÿæ­£ç¡®åœ°è¿˜åŸå‡º DOM ä¹‹é—´çš„æ’ç‰ˆå…³ç³»ã€‚</p><p>åœ¨è§£æ XHTML æ–‡ä»¶æ—¶ï¼Œæˆ‘ä½¿ç”¨äº† <a href="https://pub.dev/packages/html" target="_blank" rel="noopener noreferrer"><code>html</code></a> åº“æ¥å®Œæˆå¯¹ DOM èŠ‚ç‚¹çš„è§£æã€‚ <code>html</code> åº“å¯ä»¥å°† XHTML å†…å®¹è½¬æ¢ä¸º Dart çš„ DOM å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­çš„é€’å½’éå†å’ŒèŠ‚ç‚¹æ ‘æ„å»ºã€‚</p><p>å…¶ä¸­è¿™é‡Œé¢çš„è¿™äº› <code>Node</code> ç±»ï¼Œéƒ½æ˜¯å¯¹åº”çš„ DOM å®ç°èŠ‚ç‚¹ç±»ï¼Œå…·ä½“ç»†èŠ‚ä¼šåœ¨ <strong>ä¸‹ä¸€ä¸ªç« èŠ‚</strong> ä¸­å±•å¼€è¯´æ˜ã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘å¯¹ XHTML DOM èŠ‚ç‚¹çš„å¤„ç†é€»è¾‘ï¼š</p><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å‚æ•°è¯´æ˜ï¼š</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// nodes    â€”â€” å½“å‰èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// baseStyle â€”â€” å½“å‰èŠ‚ç‚¹å·²æœ‰çš„æ ·å¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// useCss   â€”â€” å½“å‰ä½¿ç”¨åˆ°çš„ CSS æ–‡ä»¶é›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Future</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">domParse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;dom.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nodes, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ModelStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> baseStyle, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; useCss) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodes) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> readerNode;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // æ‹·è´çˆ¶çº§æ ·å¼ï¼Œä½œä¸ºå½“å‰èŠ‚ç‚¹çš„åŸºç¡€æ ·å¼</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      ModelStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> style </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> baseStyle.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">clone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºæ–‡æœ¬èŠ‚ç‚¹å°±å¯ä»¥ç›´æ¥æ·»åŠ åˆ°è¿™ä¸ªList&lt;ReaderNode&gt; listä¸­</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //æ–‡æœ¬èŠ‚ç‚¹å°±æ˜¯ä¸ä¼šå­˜åœ¨å­èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node is dom.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Text</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> text </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node.text;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        text </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> text.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">replaceAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">trim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å»é™¤æ‰æ–‡æœ¬ä¸­çš„&#39;\n&#39;æ¢è¡Œç¬¦</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (text.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          list.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TextNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TextSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(text</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> text, style</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> style.textStyle), style, nodeIndex));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // å…ƒç´ èŠ‚ç‚¹ï¼šå¯èƒ½åŒ…å«å­èŠ‚ç‚¹ï¼Œéœ€è¦è¿›ä¸€æ­¥è§£æ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node is dom.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Element</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //åˆ¤æ–­ä½¿ç”¨äº†é‚£äº›cssæ–‡ä»¶ï¼Œå°†å¯¹åº”çš„æ ·å¼åŒ¹é…åˆ°å½“å‰çš„ModelStyleä¸­</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> css </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> useCss) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          style </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(css, style, node);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //è¡Œå†…æ ·å¼åº”ä¸ºä¸åœ¨cssæ–‡ä»¶ä¸­æ‰€ä»¥éœ€è¦å•ç‹¬çš„å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodeStyle </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node.attributes[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;style&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nodeStyle </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          style </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> style.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">merge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(cssToTextstyle.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parseInlineStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nodeStyle));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //HTMLä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºinline(è¡Œå†…)å’Œblock(å—çº§)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (blockList.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">contains</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.localName)) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BlockNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.localName</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ([</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;image&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;img&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">contains</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.localName)) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> path </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getImageBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (path </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> epubParsing.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getImage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(path);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.isEmpty) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ImageNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.localName</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex, list, path);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            await</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (readerNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ImageNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;i&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> INode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;i&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;ruby&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RubyNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ruby&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;rt&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RtNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;rt&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;br&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BrNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;br&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;del&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> DelNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;del&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.localName </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;b&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;b&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            readerNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> InlineNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.localName</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, style, nodeIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //åœ¨readerNodeæœ‰åšç‰¹æ®Šå¤„ç†å¯èƒ½è¦ç»§æ‰¿åˆ°å­èŠ‚ç‚¹ä¸­</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        style </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> readerNode.styleModel;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //é€’å½’è§£æå­èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        readerNode.children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> domParse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node.nodes, style, useCss);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // åŠ å…¥ç»“æœåˆ—è¡¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        list.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(readerNode);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      nodeIndex++;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ <code>domParse</code> æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œä¼šå¾—åˆ°ä¸€ä¸ª <strong>æ ‘å½¢ç»“æ„çš„èŠ‚ç‚¹æ ‘</strong>ï¼Œè¯¥ç»“æ„å®Œæ•´ä¿ç•™äº† XHTML ä¸­çš„å±‚çº§ä¸æ’ç‰ˆå…³ç³»ã€‚<br> ä¸ºäº†ä¾¿äºåç»­çš„ <strong>åˆ†é¡µæ¸²æŸ“</strong>ï¼Œéœ€è¦å°†è¿™ä¸ªèŠ‚ç‚¹æ ‘ä¿å­˜èµ·æ¥ï¼Œä½œä¸ºåç»­æ¸²æŸ“çš„åŸºç¡€æ•°æ®ã€‚</p><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...çœç•¥éƒ¨åˆ†ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nodeList </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> domParse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(document.body</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.nodes </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [], </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ModelStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), useCss);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nodeList.length </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    BodyNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> bodyNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BodyNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    bodyNode.children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodeList;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    nodeListList.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">([bodyNode]);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    nodeListList.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nodeList);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...çœç•¥éƒ¨åˆ†ä»£ç </span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="readernode-è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#readernode-è®¾è®¡"><span>ReaderNode è®¾è®¡</span></a></h2><p>åœ¨ EPUB é˜…è¯»å™¨çš„å®ç°ä¸­ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ <strong>å°†è§£æåçš„ XHTML DOM èŠ‚ç‚¹æ˜ å°„ä¸º Flutter å¯æ¸²æŸ“çš„èŠ‚ç‚¹æ ‘</strong>ã€‚<br> ä¸ºæ­¤ï¼Œæˆ‘è®¾è®¡äº†ä¸€å¥— <strong><code>ReaderNode</code> æŠ½è±¡ç±»</strong> åŠå…¶å­ç±»ï¼Œç”¨æ¥æ‰¿è½½ DOM çš„ <strong>è¯­ä¹‰ã€æ ·å¼ã€æ’ç‰ˆå’Œç»˜åˆ¶é€»è¾‘</strong>ã€‚</p><h3 id="æ ¸å¿ƒæ€æƒ³" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ€æƒ³"><span>æ ¸å¿ƒæ€æƒ³</span></a></h3><ul><li>æ¯ä¸€ä¸ª <code>ReaderNode</code> å¯¹åº”ç€ä¸€ä¸ª DOM èŠ‚ç‚¹ï¼Œè´Ÿè´£å­˜å‚¨è¯¥èŠ‚ç‚¹çš„ <strong>æ ·å¼ä¿¡æ¯</strong>ã€<strong>å¸ƒå±€ä½ç½®</strong>ã€<strong>å¤§å°</strong> ä»¥åŠ <strong>å­èŠ‚ç‚¹æ ‘</strong>ã€‚</li><li>è¿™æ ·ï¼Œè§£æåçš„ XHTML èŠ‚ç‚¹æ ‘å°±èƒ½ç›´æ¥å‚ä¸åˆ°åˆ†é¡µæ’ç‰ˆä¸æ¸²æŸ“ä¸­ã€‚</li></ul><h3 id="å…³é”®æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#å…³é”®æ–¹æ³•"><span>å…³é”®æ–¹æ³•</span></a></h3><ul><li><strong><code>layout</code></strong>ï¼šè´Ÿè´£è®¡ç®—èŠ‚ç‚¹åœ¨é¡µé¢ä¸­çš„å¸ƒå±€ï¼ˆä½ç½®ã€é«˜åº¦ã€å®½åº¦ï¼‰ï¼Œä»¥åŠæ˜¯å¦éœ€è¦åˆ†é¡µæˆ–æ¢è¡Œã€‚</li><li><strong><code>paint</code></strong>ï¼šè´Ÿè´£å°†èŠ‚ç‚¹ç»˜åˆ¶åˆ° <code>Canvas</code> ä¸Šã€‚</li><li><strong><code>deepUpdateOffset</code></strong>ï¼šç”¨äºåŒä¸€è¡Œå†…çš„èŠ‚ç‚¹å¯¹é½ï¼ˆå¦‚å‚ç›´å±…ä¸­ï¼‰ã€‚</li></ul><h3 id="readernode-æŠ½è±¡ç±»" tabindex="-1"><a class="header-anchor" href="#readernode-æŠ½è±¡ç±»"><span>ReaderNode æŠ½è±¡ç±»</span></a></h3><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> page </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  static</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> []; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å­èŠ‚ç‚¹åˆ—è¡¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  late</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ModelStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> styleModel;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æ ·å¼</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isTurning;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆ†åˆ†é¡µ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isEnter;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆ†è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isBranch </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//èŠ‚ç‚¹æ˜¯å¦å…è®¸åˆ†è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remainingHeight;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰é¡µé¢å‰©ä½™é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¯¥èŠ‚ç‚¹ç»˜åˆ¶çš„ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nextOffset;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»˜åˆ¶çš„ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰èŠ‚ç‚¹çš„é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰èŠ‚ç‚¹çš„å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> uniqueId;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//èŠ‚ç‚¹çš„å”¯ä¸€ID</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isCurrent </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; hasIndexList </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¯¥èŠ‚ç‚¹åŒ…æ‹¬å…¶å­èŠ‚ç‚¹çš„uniqueId</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.styleModel, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.uniqueId,{</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.isEnter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //å¸ƒå±€å‰çš„æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> layoutBefore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    hasIndexList </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [uniqueId];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    isEnter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //å¸ƒå±€æ–¹æ³•äº¤ç”±å­ç±»å®ç°</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset,{isFull </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //ç»˜åˆ¶æ–¹æ³•äº¤ç”±å­ç±»å®ç°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Canvas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> canvas, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //è¯¥æ–¹æ³•ä¸»è¦ç”¨äºåŒä¸€è¡Œå†…çš„æ‰€æœ‰èŠ‚ç‚¹å‚ç›´å±…ä¸­</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> deepUpdateOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dxDifference, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dyDifference) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> element </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      element.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">deepUpdateOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(dxDifference, dyDifference);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(currentOffset.dx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dxDifference, dyDifference </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset.dy);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nextOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.dx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dxDifference, dyDifference </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nextOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.dy);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  ReaderNode</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> clone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ç»§æ‰¿è¿™ä¸ªæ–¹æ³•å»å®ç°å¸ƒå±€ä¸ç»˜åˆ¶çš„åŠŸèƒ½ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªæœ€é‡è¦çš„å®ç°ç±»ï¼Œ</p><h3 id="textnode-ç±»" tabindex="-1"><a class="header-anchor" href="#textnode-ç±»"><span>TextNode ç±»</span></a></h3><p><code>TextNode</code> ç±»ç»§æ‰¿è‡ª <code>ReaderNode</code> æŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨äº <strong>ç»˜åˆ¶æ–‡æœ¬</strong>ã€‚<br> å®ƒçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å€ŸåŠ© <strong>Flutter çš„ <code>TextPainter</code></strong> æ¥å®Œæˆæ–‡æœ¬çš„ <strong>å¸ƒå±€è®¡ç®—</strong> ä¸ <strong>æ¸²æŸ“ç»˜åˆ¶</strong>ã€‚</p><p>åœ¨ <code>layout</code> æ–¹æ³•ä¸­ï¼Œ<code>TextNode</code> è´Ÿè´£ä»¥ä¸‹å·¥ä½œï¼š</p><ul><li>å½“ <code>availableWidth</code>ï¼ˆå¯ç”¨å®½åº¦ï¼‰ä¸è¶³æ—¶ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œ <strong>åˆ‡å‰²æ¢è¡Œ</strong>ã€‚</li><li>å½“æ–‡æœ¬é«˜åº¦è¶…è¿‡ <code>remainingHeight</code>ï¼ˆé¡µé¢å‰©ä½™é«˜åº¦ï¼‰æ—¶ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œ <strong>åˆ†é¡µæˆªæ–­</strong>ã€‚</li><li>è®¡ç®—èŠ‚ç‚¹çš„ <strong>ä½ç½® (Offset)</strong>ã€<strong>é«˜åº¦</strong>ã€<strong>å®½åº¦</strong>ï¼Œå¹¶ç”Ÿæˆä¸‹ä¸€èŠ‚ç‚¹çš„èµ·å§‹åæ ‡ã€‚</li></ul><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextNode</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  TextSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åœ¨è§£æDomæ—¶ä¼ å…¥çš„æ–‡æœ¬å†…å®¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  TextPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; listNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¿”å›å‡ºå»äº¤ç”±ElementNodeå¤„ç†çš„é›†åˆ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  TextNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.textSpan,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.styleModel,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.uniqueId</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //å½“è¿™é‡Œçš„textPainterä¸ä¸ºnullçš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ç»˜åˆ¶è¿™ä¸ªæ–‡æœ¬åˆ°ç”»å¸ƒä¸Šäº†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Canvas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> canvas, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (textPainter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(canvas, offset);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // å¸ƒå±€æ–¹æ³•ï¼šè®¡ç®—æ–‡æœ¬çš„å®½é«˜ã€åˆ†é¡µé€»è¾‘ã€æ¢è¡Œé€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset, {isFull </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    layoutBefore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // åˆå§‹åŒ– TextPainter</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    textPainter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(text</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan, textDirection</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextDirection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ltr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(maxWidth</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lastWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æœ€åä¸€è¡Œçš„å®½åº¦ï¼Œä»¥æ–¹ä¾¿è®¡ç®—</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å¤´</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">isFull) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //å¦‚æœä¸æ˜¯å¼€å¤´çš„è¯(æ„åŠæ”¹è¡Œä¸­æœ‰å…¶ä»–çš„èŠ‚ç‚¹å­˜åœ¨)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // è·å–åœ¨æœ€å¤§å®½åº¦å¤„çš„æ–‡æœ¬ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      TextPosition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pos </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getPositionForOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(availableWidth, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> splitIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pos.offset;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (splitIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.text</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.length) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //è¯¥è¡Œæ”¾ä¸ä¸‹æ‰€æœ‰çš„æ–‡æœ¬ï¼Œå°†åˆ†è¡Œæ ‡è®°ä¸ºtrueç­‰å¾…ElementNodeå¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        isEnter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (splitIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (splitIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.text</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.length </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">isBranch)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          segmentation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> listNode;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        segmentation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(splitIndex, availableWidth);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //é€šè¿‡computeLineMetricsæ–¹æ³•æ¥è·å–åˆ°æ–‡æœ¬å¸ƒå±€çš„è¯¦ç»†è¡Œåº¦é‡ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">LineMetrics</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">computeLineMetrics</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (list.isEmpty) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    lastWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.last.width;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //å½“æ–‡æœ¬çš„é«˜åº¦å¤§äºé¡µé¢å‰©ä½™é«˜åº¦å°±è¦å¼€å§‹å¤„ç†åˆ†é¡µçš„é—®é¢˜</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.height </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remainingHeight</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> totalHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">LineMetrics</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineMetrics </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        totalHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineMetrics.height;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å°†æ¯ä¸€è¡Œæ–‡æœ¬çš„é«˜åº¦ç›¸åŠ </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (totalHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remainingHeight</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //è¿™é‡Œçš„è®¡ç®—æ—¶å› ä¸ºè€ƒè™‘åˆ°æ–‡æœ¬ä¸å¯èƒ½æ¯ä¸€è¡Œéƒ½å¯ä»¥å®Œå®Œå…¨å…¨çš„å æ»¡ï¼Œæœ€åä¸€è¡Œæœ‰å¯èƒ½æœ‰å‰©ä½™çš„å®½åº¦å¯ä»¥ç»™åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœç›´æ¥æ‹¿å–textPainterçš„å®½åº¦çš„è¯ï¼Œæ˜¯ç›´æ¥æ‹¿åˆ°æ•´ä¸ªæ–‡æœ¬çš„å®½åº¦ï¼Œè€Œä¸æ˜¯æœ€åä¸€è¡Œçš„å®½åº¦ï¼Œæ‰€ä»¥è¿™é‡Œè¦å°†è¿™ä¸ªæœ€åä¸€è¡Œçš„å®½åº¦è®¡ç®—å‡ºæ¥</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineEndOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getPositionForOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(lineMetrics.left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineMetrics.width, lineMetrics.baseline)).offset;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        lastWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineMetrics.width;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        endOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lineEndOffset;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //å°†åˆ†é¡µæ ‡è®°æ”¹ä¸ºtrue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      segmentation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(endOffset, availableWidth);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.last.width </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset.dx;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ¨Xè½´ä¸Šçš„ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset.dy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.height </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.last.height;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ¨Yè½´ä¸Šçš„ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.height;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.width;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(dx, dy);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> listNode;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> segmentation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> index, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> maxWidth) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remainingText </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.text</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">substring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(index);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    TextSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newTextSpan </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(text</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> remainingText, style</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.style);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    TextNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newTextNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(newTextSpan, styleModel,uniqueId);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    listNode.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">insert</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, newTextNode);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentText </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.text</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">substring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, index);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    textSpan </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextSpan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(text</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentText, style</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan.style);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    textPainter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(text</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> textSpan, textDirection</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> TextDirection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ltr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    textPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(maxWidth</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> maxWidth);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="elementnode-ç±»" tabindex="-1"><a class="header-anchor" href="#elementnode-ç±»"><span>ElementNode ç±»</span></a></h3><p><code>ElementNode</code> ç»§æ‰¿è‡ª <code>ReaderNode</code>ï¼Œæ˜¯æ¸²æŸ“å™¨ä¸­ <strong>è´Ÿè´£æ•´ä½“å¸ƒå±€ä¸æ’ç‰ˆçš„æ ¸å¿ƒèŠ‚ç‚¹</strong>ã€‚<br> ç”±äº DOM è§£æåçš„å†…å®¹ä¼šè¢«ç»„ç»‡ä¸º <code>ReaderNode</code> æ ‘ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹çš„æ’ç‰ˆä¸åˆ†é¡µé€»è¾‘ï¼Œéƒ½ä¼šåœ¨ <code>ElementNode</code> çš„ <code>layout</code> æ–¹æ³•ä¸­è¢«ç»Ÿä¸€è°ƒåº¦ä¸å¤„ç†ã€‚</p><p>å®ƒçš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š</p><ul><li><strong>å­èŠ‚ç‚¹æ’ç‰ˆç®¡ç†</strong>ï¼šé€ä¸ªå¯¹å­èŠ‚ç‚¹è°ƒç”¨ <code>layout</code>ï¼Œå¹¶æ ¹æ®è¡Œå†…/å—çº§ç‰¹æ€§è¿›è¡Œå¸ƒå±€ã€‚</li><li><strong>åˆ†é¡µé€»è¾‘æ§åˆ¶</strong>ï¼šå½“å½“å‰é¡µå‰©ä½™é«˜åº¦ä¸è¶³æ—¶ï¼Œè§¦å‘åˆ†é¡µå¹¶å…‹éš†è‡ªèº«ï¼Œä»¥ä¿æŒæ ‘ç»“æ„çš„å®Œæ•´æ€§ã€‚</li><li><strong>å—çº§ä¸è¡Œå†…å…ƒç´ åŒºåˆ†</strong>ï¼š <ul><li>å—çº§å…ƒç´ ç‹¬å ä¸€è¡Œï¼Œä¼šå¤„ç†å¤–è¾¹è·ä¸å†…è¾¹è·ã€‚</li><li>è¡Œå†…å…ƒç´ åˆ™ä¼šå‚ä¸åŒä¸€è¡Œçš„æ’ç‰ˆï¼Œå¹¶è‡ªåŠ¨å¯¹é½è°ƒæ•´ã€‚</li></ul></li><li><strong>è¡Œå†…é«˜åº¦å¯¹é½</strong>ï¼šè‹¥åŒä¸€è¡Œå†…çš„èŠ‚ç‚¹é«˜åº¦ä¸ä¸€è‡´ï¼Œä¼šé€šè¿‡ <code>rearrangement</code> æ–¹æ³•é‡æ–°è°ƒæ•´åç§»ï¼Œä¿è¯è§†è§‰å¯¹é½ã€‚</li><li><strong>é€’å½’æ¸²æŸ“</strong>ï¼šåœ¨ <code>paint</code> é˜¶æ®µä¼šé€’å½’è°ƒç”¨å­èŠ‚ç‚¹çš„ <code>paint</code>ï¼Œæœ€ç»ˆå®Œæˆæ•´é¡µå†…å®¹çš„ç»˜åˆ¶ã€‚</li></ul><p>å› æ­¤ï¼Œ<code>ElementNode</code> å¯ä»¥ç†è§£ä¸º <strong>ReaderNode æ ‘çš„â€œç‰ˆé¢è°ƒåº¦å™¨â€</strong>ï¼Œå®ƒä¸ä»…è´Ÿè´£ç®¡ç†å­èŠ‚ç‚¹çš„ä½ç½®ä¸åˆ†é¡µï¼Œè¿˜ä¿è¯äº†æ•´æ£µæ¸²æŸ“æ ‘åœ¨è§†è§‰å’Œé€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç±»ç»§æ‰¿è‡ª <code>ElementNode</code>ï¼Œå®ƒä»¬å¯èƒ½ä¼šé‡å†™ <code>layout</code> æ–¹æ³•ä»¥å®ç°æ›´ç‰¹æ®Šçš„å¸ƒå±€é€»è¾‘ã€‚<br> ä½†åœ¨è¿™é‡Œä¸å±•å¼€è¯´æ˜ï¼Œ<strong><code>ElementNode</code> æ˜¯æ¸²æŸ“å™¨ä¸­æ‰®æ¼”å¸ƒå±€é‡ä»»çš„æ ¸å¿ƒç±»</strong>ï¼Œæ˜¯æ•´ä¸ª ReaderNode æ ‘æœ€ç»ˆæ’ç‰ˆçš„è°ƒåº¦å™¨ã€‚</p><details><summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ElementNode</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tag; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æ ‡ç­¾</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  ElementNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.tag,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.styleModel,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.uniqueId,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> defaultDx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> defaultDy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isOver </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦å®Œæˆäº†</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; truncatedNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æ‹¿å–è£æ–­åˆ†é¡µèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nextPageNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æœ¬é¡µæ”¾ä¸ä¸‹è¦åˆ°ä¸‹é¡µæ¸²æŸ“çš„èŠ‚ç‚¹é›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰è¡Œçš„é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰è¡Œçš„å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> truncatedIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; currentLineIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> []; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“å‰è¡Œå«æœ‰çš„æ‰€æœ‰å­èŠ‚ç‚¹ä¸‹æ ‡</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> highlyInconsistent </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åˆ¤æ–­æ˜¯å¦å‚ç›´å±…ä¸­</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset, {isFull}) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    layoutBefore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    remainingHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NodeStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageHeight;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å½“remainingHeightä¸ºç©ºåˆ™ç›´æ¥é‚£å½“å‰çš„é¡µé¢çš„é«˜åº¦ä½œä¸ºå‰©ä½™é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    defaultDx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset.dx;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> top </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //åˆ¤æ–­å¦‚æœä¸ºå—çº§å…ƒç´ åˆ™è¦åŠ ä¸Šè¿™ä¸ªå¤–è¾¹è·å’Œå†…è¾¹è·çš„å®ç°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> is </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BlockNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> applyEdgeInsets</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">EdgeInsets</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> insets) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (insets </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> insets.left </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> insets.right;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        defaultDx </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> insets.left;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (insets.top </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isOver) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          top </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> insets.top;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      applyEdgeInsets</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(styleModel.margin);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      applyEdgeInsets</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(styleModel.padding);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //å°†é«˜åº¦å’Œé»˜è®¤ä½ç½®çš„yè½´åŠ ä¸Šå¯¹åº”çš„å¤–è¾¹è·å’Œå†…è¾¹è·ä¸Šè¾¹çš„å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    defaultDy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset.dy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> top;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> top;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //åˆ¤æ–­æœç„¶å½“å‰çš„ä½ç½®ä»¥åŠé«˜å‡ºé¡µé¢çš„é«˜åº¦ä»¥åŠè¿™ä¸ªèŠ‚ç‚¹è¿˜å­˜åœ¨å­èŠ‚ç‚¹å°±ç›´æ¥åˆ†é¡µ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (defaultDy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NodeStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (isTurning) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //éœ€è¦åˆ†é¡µçš„æ—¶å€™ç›´æ¥å…‹éš†ä¸€ä¸ªè‡ªå·±</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> blockNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> clone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      blockNode.currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      blockNode.children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [blockNode];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nextChildOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, defaultDy);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> unchanged </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (children.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> childIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //è¿™é‡Œä½¿ç”¨whileè€Œä¸æ˜¯ä½¿ç”¨forå»å¾ªç¯è¿™ä¸ªchildrençš„åŸå› æ˜¯éœ€è¦é¿å…åœ¨å¾ªç¯ä¸­ä¿®æ”¹äº†childrené•¿åº¦çš„å‰¯ä½œç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (childIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children.length) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children[childIndex];</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //è®¡ç®—å­èŠ‚ç‚¹å‰©ä½™å¯ä½¿ç”¨çš„é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //ä½¿ç”¨é¡µé¢é«˜åº¦ - å½“å‰èŠ‚ç‚¹çš„Yè½´ä¸Šçš„ä½ç½® - å½“å‰èŠ‚ç‚¹ï¼ˆåŒ…å«æ‰€æœ‰å·²å¤„ç†çš„å­èŠ‚ç‚¹ï¼‰çš„é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        child.remainingHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NodeStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset.dy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentHeight;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isFull </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> unchanged </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åˆ¤æ–­æ˜¯å¦è¡Œé¦–ï¼ˆæ„ä¸ºåˆ¤æ–­æ˜¯å¦ä¸ºè¯¥è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        child.isBranch </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isBranch; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//æ˜¯å¦å…è®¸æ–‡æœ¬åˆ†è¡Œï¼ˆè¿™é‡Œæ˜¯ä¸ºäº†ç»™ä¾‹å¦‚Rubyæ ‡ç­¾è¿™æ ·çš„èŠ‚ç‚¹ä½¿ç”¨çš„ï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //åˆ¤æ–­æ˜¯å—çº§èŠ‚ç‚¹è¿˜æ˜¯å…¶ä»–èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child is </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BlockNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŠ ä¸Šä¸Šä¸€è¡Œçš„æœ€ç»ˆé«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // å—çº§èŠ‚ç‚¹Yè½´ä»å½“å‰èŠ‚ç‚¹ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯è¿™ä¸ªå—çº§èŠ‚ç‚¹çš„çˆ¶çº§ï¼‰é«˜åº¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          nextChildOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, offset.dy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentHeight);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          //å› ä¸ºæ˜¯å—çº§èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é‚£unchangedï¼ˆæœ€å¤§å®½åº¦ï¼‰æ¥ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          truncatedNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(unchanged, nextChildOffset);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.currentHeight;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // å› ä¸ºå—çº§èŠ‚ç‚¹æ˜¯ç‹¬å çš„å­˜åœ¨ï¼Œä¸å¯èƒ½æœ‰å…¶ä»–èŠ‚ç‚¹ä¼šå’Œå—çº§èŠ‚ç‚¹åœ¨åŒä¸€è¡Œçš„</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // æ‰€ä»¥å¯ä»¥ç›´æ¥æ¸…ç©ºcurrentLineHeightå»ç»™ä¸‹ä¸€è¡Œåšåˆ¤æ–­</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          truncatedNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(availableWidth, nextChildOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, isFull</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isFull);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          //å åŠ è®¡ç®—è¿™ä¸ªè¡Œå†…çš„æ‰€æœ‰å…ƒç´ çš„å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.currentWidth;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          //åˆ¤æ–­å½“å‰è¡Œçš„é«˜åº¦å’Œè¿™ä¸ªè¡Œå†…å…ƒç´ çš„é«˜åº¦ï¼Œå¦‚æœé«˜åº¦ä¸åŒæ ‡è®°highlyInconsistentä¸ºtrue</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child.currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">              !</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">highlyInconsistent) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            highlyInconsistent </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          //è¿™é‡Œå†è´§æ¯”åŒä¸€è¡Œå†…çš„æ‰€æœ‰Nodeçš„é«˜åº¦ï¼Œæ‹¿å–æœ€é«˜çš„èŠ‚ç‚¹é«˜åº¦ä¸ºå½“å‰è¡Œçš„é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(currentLineHeight, child.currentHeight); </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          //è®¡ç®—å½“å‰è¡Œçš„å‰©ä½™å¯ç”¨å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.currentWidth;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineIndex.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(childIndex);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        currentWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(currentWidth, currentLineWidth);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //è¿™é‡Œå°†è¯¥å­èŠ‚ç‚¹å«æœ‰æ‰€æœ‰çš„ä¸‹æ ‡æ·»åŠ åˆ°å½“å‰èŠ‚ç‚¹çš„hasIndexListä¸‹ï¼Œåç»­è¦åšå·²çœ‹è¿›åº¦çš„è·³è½¬</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //æ ¹æ®è¿™ä¸ªä¸‹æ ‡çš„å€¼æ¥è·³è½¬ç›¸åº”çš„é¡µç </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        hasIndexList.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(child.hasIndexList);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child.isEnter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          rearrangement</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          currentLineIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child.isTurning) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            //å¦‚æœå­èŠ‚ç‚¹çš„isTurningæ ‡è®°ä¸ºtrueå°±ä»£è¡¨ä»è¿™ä¸ªå­èŠ‚ç‚¹å¼€å§‹éœ€è¦åˆ†é¡µäº†</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            //å½“å‰èŠ‚ç‚¹ä¹Ÿæ ‡è®°ä¸ºéœ€è¦åˆ†é¡µï¼Œå‘ä¸Šä¼ é€’</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            isTurning </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            turning</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(childIndex);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child.isEnter </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            //å½“å­èŠ‚ç‚¹éœ€è¦åˆ†è¡Œæˆ–è€…æ˜¯å½“å‰å‰©ä½™å®½åº¦å·²ç»ä¸å¤Ÿç”¨äº†</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            availableWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> unchanged;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            nextChildOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, defaultDy </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentHeight);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            childIndex++;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            //å¾€å½“å‰èŠ‚ç‚¹çš„å­—èŠ‚æ’å…¥ä¸€ä¸ªæ–°çš„åˆ†è¡Œåçš„èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            children.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">insertAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(childIndex, truncatedNode);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nextChildOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, defaultDy);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        childIndex++;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        isOver </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      rearrangement</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //å¤„ç†æœ€åä¸€è¡Œçš„é«˜åº¦æ²¡æœ‰æ·»åŠ åˆ°å½“å‰çš„èŠ‚ç‚¹çš„é«˜åº¦ä¸Š</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //åˆ¤æ–­å¦‚æœä¸ºå—çº§å…ƒç´ åˆ™è¦åŠ ä¸Šè¿™ä¸ªå¤–è¾¹è·å’Œå†…è¾¹è·çš„å®ç°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> is </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BlockNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //åˆ¤æ–­isOverçš„åŸå› æ˜¯å¯èƒ½è¿™ä¸ªå—çº§èŠ‚ç‚¹åœ¨è¿™ä¸ªé¡µé¢è£…ä¸ä¸‹äº†ï¼Œç„¶åéœ€è¦å»åˆ°ä¸‹ä¸€é¡µ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      //é‚£ä¹ˆå½“å‰é¡µé¢çš„è¿™ä¸ªå—çº§èŠ‚ç‚¹å°±ä¸éœ€è¦ä¸‹è¾¹çš„è¾¹è·äº†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (isOver) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (styleModel.padding</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.bottom </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (styleModel.margin</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.bottom </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nextChildOffset;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //truncatedIndexä¸ä¸º-1çš„æ—¶å€™è¯´æ˜å½“å‰é¡µé¢æ˜¯éœ€è¦åˆ†é¡µï¼Œæ‰€ä»¥ç›´æ¥è£æ–­è¿™ä¸ªchildren</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //è¿™æ ·åœ¨è°ƒç”¨printæ–¹æ³•ç»˜åˆ¶çš„æ—¶å€™å°±ä¸ä¼šå‡ºç°ç»˜åˆ¶å¤šä½™çš„èŠ‚ç‚¹äº†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (children.isNotEmpty </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> truncatedIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sublist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, truncatedIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nextPageNode;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> turning</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(childIndex) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    isOver </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //æ‹·è´ä¸€ä¸ªå½“å‰èŠ‚ç‚¹ï¼Œä»¥ç»´æŒåŸæœ¬çš„æ ‘å½¢ç»“æ„</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> elementNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> clone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //truncatedNodeåœ¨ä¸Šé¢å¾ªç¯çš„æ—¶å€™å·²ç»æ‹¿åˆ°äº†å­èŠ‚ç‚¹layoutæ–¹æ³•è¿”å›å‡ºæ¥çš„åˆ†é¡µèŠ‚ç‚¹äº†</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //æ‰€ä»¥åœ¨è¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨addAllå°†childIndexä»¥åçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ”¾å…¥è¿™ä¸ªtruncatedNodeä¸­</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    truncatedNode.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(children.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">skip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(childIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    elementNode.children </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> truncatedNode; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å°†truncatedNodeå½“ä¸ºè¿™ä¸ªæ‹·è´èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    elementNode.currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(defaultDx, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    truncatedIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> childIndex;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    nextPageNode </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [elementNode];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> rearrangement</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //è¿™é‡Œæ˜¯åˆ¤æ–­è¿™ä¸ªè¡Œå†…çš„æ‰€æœ‰èŠ‚ç‚¹é«˜åº¦æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒçš„è¯å¯èƒ½ä¼šå‡ºç°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¯”ç¬¬äºŒä¸ªèŠ‚ç‚¹çŸ®ä¸€æˆªçš„æƒ…å†µ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //æ‰€ä»¥è¿™é‡Œéœ€è¦å°†è¿™æ ·çš„èŠ‚ç‚¹ç»™é‡æ–°ç¼–æ’ä¸€è¾¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (currentLineIndex.isNotEmpty </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> highlyInconsistent) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> index </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineIndex) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children[index];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (child.currentHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> difference </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentLineHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child.currentHeight;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        child.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">deepUpdateOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, difference);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        children[index] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      currentLineIndex.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">clear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      highlyInconsistent </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //é€’å½’ç»˜åˆ¶å­èŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Canvas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> canvas, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> offset) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (children.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> child </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        child.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(canvas, child.currentOffset);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h2 id="åˆ†é¡µè®¡ç®—" tabindex="-1"><a class="header-anchor" href="#åˆ†é¡µè®¡ç®—"><span>åˆ†é¡µè®¡ç®—</span></a></h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»å®Œæˆäº† <strong>EPUB æ–‡ä»¶è§£æ</strong>ã€<strong>CSS æ ·å¼è§£æ</strong> ä»¥åŠ <strong>èŠ‚ç‚¹æ ‘çš„ç”Ÿæˆ</strong>ã€‚<br> å…¶ä¸­ <code>ElementNode</code> è´Ÿè´£ <strong>å¸ƒå±€å¤„ç†</strong>ï¼Œ<code>TextNode</code> è´Ÿè´£ <strong>æ–‡æœ¬æ’ç‰ˆ</strong>ï¼Œä½†è¦å®ç°é˜…è¯»å™¨çš„å®Œæ•´ä½“éªŒï¼Œè¿˜éœ€è¦ä¸€ä¸ª <strong>åˆ†é¡µå™¨</strong> æ¥æŠŠæ•´ä¸ªç« èŠ‚æ‹†åˆ†æˆå¯ç¿»é¡µçš„é¡µé¢ã€‚</p><h3 id="pagenodes-ç±»" tabindex="-1"><a class="header-anchor" href="#pagenodes-ç±»"><span>PageNodes ç±»</span></a></h3><p><code>PageNodes</code> çš„èŒè´£æ˜¯ï¼š</p><ul><li>æŒæœ‰ä¸€ä¸ª <code>List&lt;List&lt;ReaderNode&gt;&gt;</code>ï¼Œæ¯ä¸ªå­ <code>List</code> ä»£è¡¨ä¸€é¡µçš„èŠ‚ç‚¹æ ‘ã€‚</li><li>é€’å½’è°ƒç”¨å„ä¸ª <code>ReaderNode</code> çš„ <code>layout</code> æ–¹æ³•ï¼Œå®ç°åˆ†é¡µé€»è¾‘ã€‚</li><li>è®¡ç®—å¹¶è®°å½•æ€»é¡µæ•°ã€é˜…è¯»è¿›åº¦ã€‚</li></ul><p>æ ¸å¿ƒæµç¨‹ï¼š</p><ol><li>éå†ç« èŠ‚èŠ‚ç‚¹æ ‘</li><li>è°ƒç”¨ <code>layout</code> è·å–æ’ç‰ˆç»“æœ</li><li>è‹¥èŠ‚ç‚¹è¶…å‡ºå½“å‰é¡µé«˜åº¦ï¼Œåˆ™ç”Ÿæˆ <strong>spillover</strong>ï¼ˆæº¢å‡ºèŠ‚ç‚¹ï¼‰ï¼Œæ”¾å…¥ä¸‹ä¸€é¡µç»§ç»­å¤„ç†</li><li>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ª <strong>åˆ†é¡µåçš„èŠ‚ç‚¹æ ‘é›†åˆ</strong></li></ol><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> PageNodes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; list </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pageCount </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> readRecodesIndex;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pageHeight;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pageWidth;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isColumn;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> columnNum;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;&gt; unallocated;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> _paginateChapter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; chapterRootNodes) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    NodeStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageHeight </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pageHeight;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    NodeStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageWidth </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pageWidth;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nodesToLayout </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(chapterRootNodes);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nodesToLayout.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; currentPageNodes </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nodesForNextPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [];</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.zero;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodesToLayout.length; i++) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        final</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodesToLayout[i];</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; spillover </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">layout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(pageWidth, currentOffset);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        currentPageNodes.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(node);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (node.hasIndexList.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">contains</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(readRecodesIndex)) readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.length </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentPageNodes.length;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (spillover.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          nodesForNextPage.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(spillover);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodesToLayout.length) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            nodesForNextPage.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nodesToLayout.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sublist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        currentOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node.nextOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">??</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (currentPageNodes.isNotEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        list.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(currentPageNodes);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nodesToLayout.isNotEmpty </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodesForNextPage.isEmpty) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        nodesForNextPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(nodesToLayout);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      nodesToLayout </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodesForNextPage;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> _start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> unallocated) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      _paginateChapter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(item);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    pageCount </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isColumn </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (list.length </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> columnNum).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ceil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> list.length;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> isColumn </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> columnNum).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ceil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> readPage;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, readPage </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  PageNodes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.unallocated, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageWidth, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.pageHeight,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      {</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.isColumn </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.columnNum </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.readRecodesIndex </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    _start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="é¡µé¢æ¸²æŸ“" tabindex="-1"><a class="header-anchor" href="#é¡µé¢æ¸²æŸ“"><span>é¡µé¢æ¸²æŸ“</span></a></h2><p>åœ¨å®Œæˆåˆ†é¡µåï¼Œå¾—åˆ°çš„ <code>PageNodes</code> æ•°æ®å³å¯ç›´æ¥ç”¨äº é¡µé¢ç»˜åˆ¶ã€‚<br> è¿™é‡Œä½¿ç”¨ <code>CustomPainter</code> å¾ªç¯ç»˜åˆ¶èŠ‚ç‚¹æ ‘ï¼Œè¾¾åˆ°å®Œæ•´çš„é˜…è¯»å™¨æ¸²æŸ“æ•ˆæœï¼š</p><div class="language-dart line-numbers-mode" data-highlighter="shiki" data-ext="dart" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-dart"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReaderPainter</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CustomPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; nodeList;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  ReaderPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.nodeList);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Canvas</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> canvas, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> size) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReaderNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> node </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nodeList) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      node.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">paint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(canvas, node.currentOffset);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  @override</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  bool</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> shouldRepaint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">covariant</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CustomPainter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> oldDelegate) =&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ€»ç»“ä¸å±•æœ›" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“ä¸å±•æœ›"><span>æ€»ç»“ä¸å±•æœ›</span></a></h2><p>è‡³æ­¤ï¼Œä¸€ä¸ªç®€æ˜“ EPUB é˜…è¯»å™¨çš„æ ¸å¿ƒæ¸²æŸ“å¼•æ“å·²ç»æ„å»ºå®Œæˆã€‚æ•´ä¸ªæµç¨‹è‡ªåº•å‘ä¸Šï¼Œå®ç°äº†ä»æ–‡ä»¶è§£æåˆ°æœ€ç»ˆç»˜åˆ¶çš„å®Œæ•´é—­ç¯ã€‚</p><h3 id="æ ¸å¿ƒæ¸²æŸ“æµç¨‹æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ¸²æŸ“æµç¨‹æ€»ç»“"><span>æ ¸å¿ƒæ¸²æŸ“æµç¨‹æ€»ç»“</span></a></h3><p>æ¸²æŸ“å¼•æ“çš„å®ç°å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å››ä¸ªå…³é”®æ­¥éª¤ï¼š</p><ol><li><p><strong>è§£æ</strong>ï¼šé¦–å…ˆï¼Œå¯¹ EPUB åŒ…å†…çš„ XHTML å†…å®¹è¿›è¡Œ DOM è§£æï¼ŒåŒæ—¶è§£æ CSS æ ·å¼è¡¨ï¼Œå»ºç«‹èµ·å†…å®¹ä¸æ ·å¼çš„åˆæ­¥æ˜ å°„å…³ç³»ã€‚</p></li><li><p><strong>èŠ‚ç‚¹æ ‘æ„å»º</strong>ï¼šå°†è§£æåçš„ DOM å’Œ CSS æ•°æ®ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„ã€æ›´é€‚åˆæ¸²æŸ“å’Œæ’ç‰ˆçš„å†…éƒ¨èŠ‚ç‚¹æ ‘ç»“æ„ï¼ˆå¦‚ <code>ReaderNode</code>ã€<code>ElementNode</code>ã€<code>TextNode</code>ï¼‰ã€‚è¿™æ£µæ ‘æ˜¯åç»­æ‰€æœ‰æ“ä½œçš„åŸºç¡€ã€‚</p></li><li><p><strong>åˆ†é¡µè®¡ç®—</strong>ï¼šè¿™æ˜¯å®ç°é˜…è¯»å™¨ç¿»é¡µä½“éªŒçš„æ ¸å¿ƒã€‚é€šè¿‡éå†èŠ‚ç‚¹æ ‘è°ƒç”¨èŠ‚ç‚¹çš„<code>layout</code>æ–¹æ³•å°†èŠ‚ç‚¹åˆ†é…åˆ°ä¸åŒçš„é¡µé¢ï¼ˆ<code>PageNodes</code>ï¼‰ï¼Œå®Œæˆå†…å®¹çš„åˆ†é¡µã€‚</p></li><li><p><strong>ç»˜åˆ¶</strong>ï¼šæœ€åï¼Œåˆ©ç”¨ Flutter çš„ <code>CustomPaint</code>ï¼Œå°†è®¡ç®—å¥½çš„é¡µé¢èŠ‚ç‚¹ï¼ˆ<code>PageNodes</code>ï¼‰é«˜æ•ˆåœ°ç»˜åˆ¶åˆ°å±å¹•ç”»å¸ƒä¸Šï¼Œæœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·ã€‚</p></li></ol><p>é€šè¿‡ä¸Šè¿°æµç¨‹ï¼Œå†é…åˆ <code>PageView</code> ç­‰ç¿»é¡µæ§ä»¶ï¼Œä¸€ä¸ªåŸºç¡€çš„ EPUB é˜…è¯»ä½“éªŒä¾¿å¾—ä»¥å®ç°ã€‚</p><h3 id="å½“å‰å®ç°çš„å±€é™ä¸æœªæ¥å±•æœ›" tabindex="-1"><a class="header-anchor" href="#å½“å‰å®ç°çš„å±€é™ä¸æœªæ¥å±•æœ›"><span>å½“å‰å®ç°çš„å±€é™ä¸æœªæ¥å±•æœ›</span></a></h3><p>å°½ç®¡æ ¸å¿ƒåŠŸèƒ½å·²ç»å®Œæˆï¼Œä½†å½“å‰çš„æ¸²æŸ“å™¨ä»å¤„äºæ—©æœŸé˜¶æ®µï¼Œå­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œä¹Ÿä¸ºæœªæ¥çš„è¿­ä»£æŒ‡æ˜äº†æ–¹å‘ï¼š</p><ul><li><p><strong>æ ‡ç­¾å…¼å®¹æ€§æœ‰é™</strong>ï¼šç›®å‰ä»…å®ç°äº†å¯¹éƒ¨åˆ†å¸¸ç”¨ HTML æ ‡ç­¾çš„æ”¯æŒã€‚è‹¥è¦å®Œç¾å…¼å®¹æ‰€æœ‰ EPUB æ–‡ä»¶ï¼Œéœ€è¦æŒç»­æ‰©å±•å’Œå®Œå–„å¯¹æ›´å¤šæ ‡ç­¾ï¼ˆå¦‚è¡¨æ ¼ã€å¤æ‚åˆ—è¡¨ã€å¤šåª’ä½“ç­‰ï¼‰çš„è§£æä¸æ¸²æŸ“ã€‚</p></li><li><p><strong>å¯¼èˆªä¸å®šä½æœºåˆ¶</strong>ï¼šå½“å‰çš„é˜…è¯»è¿›åº¦è®°å½•å’Œè·³è½¬åŠŸèƒ½é‡‡ç”¨äº†è¾ƒä¸ºå–å·§çš„ä¸´æ—¶æ–¹æ¡ˆã€‚æœªæ¥å¯ä»¥å‡çº§ä¸ºéµå¾ª EPUB å®˜æ–¹ <code>CFI (Canonical Fragment Identifier)</code> è§„èŒƒçš„æ–¹å¼ï¼Œå®ç°æ›´ç²¾å‡†ã€æ›´å…·é€šç”¨æ€§çš„ä¹¦ç­¾å’Œè·³è½¬åŠŸèƒ½ã€‚</p></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå¯¹äºåŒ…å«å¤§é‡å›¾ç‰‡æˆ–å¤æ‚æ ·å¼çš„ä¹¦ç±ï¼Œåˆ†é¡µè®¡ç®—å’Œç»˜åˆ¶çš„æ€§èƒ½ä»æœ‰æå‡ç©ºé—´ã€‚å¯ä»¥æ¢ç´¢æ›´ä¼˜çš„ç®—æ³•ã€æ‡’åŠ è½½æˆ–ç¼“å­˜ç­–ç•¥æ¥æå‡å¤§å‹ä¹¦ç±çš„åŠ è½½é€Ÿåº¦å’Œç¿»é¡µæµç•…åº¦ã€‚</p></li><li><p><strong>åŠŸèƒ½æ‰©å±•</strong>ï¼šåœ¨ç°æœ‰åŸºç¡€ä¸Šï¼Œæœªæ¥è¿˜å¯ä»¥æ·»åŠ æ›´å¤šé«˜çº§åŠŸèƒ½ï¼Œå¦‚ï¼šå…¨æ–‡æœç´¢ã€æ–‡æœ¬é«˜äº®ä¸ç¬”è®°ã€ä¸»é¢˜åˆ‡æ¢ã€å­—ä½“è®¾ç½®ç­‰ï¼Œä»è€Œæ‰“é€ ä¸€ä¸ªåŠŸèƒ½æ›´å…¨é¢ã€ä½“éªŒæ›´å®Œå–„çš„ EPUB é˜…è¯»å™¨ã€‚</p></li></ul><hr><p>æ„Ÿè°¢æ‚¨ä¸€è·¯çœ‹åˆ°è¿™é‡Œï¼Œä»¥ä¸Šå°±æ˜¯æˆ‘æ„å»ºè¿™ä¸ª EPUB é˜…è¯»å™¨æ ¸å¿ƒå¼•æ“çš„å®Œæ•´å¿ƒè·¯å†ç¨‹å’ŒæŠ€æœ¯æ€»ç»“ã€‚è¿™ä¸ªé¡¹ç›®ç›®å‰ä»å¤„äºåˆçº§é˜¶æ®µï¼Œæœ‰è®¸å¤šå¯ä»¥å®Œå–„å’Œæ¢ç´¢çš„åœ°æ–¹ï¼Œå¸Œæœ›æˆ‘çš„åˆ†äº«èƒ½èµ·åˆ°æŠ›ç –å¼•ç‰çš„ä½œç”¨ã€‚æœŸå¾…ä¸æ‚¨åœ¨æœªæ¥çš„å¼€å‘ä¸­è¿›ä¸€æ­¥äº¤æµæ¢è®¨ã€‚</p></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/qqaazz2/qqaazz2.github.io/edit/main/src/posts/a.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last Updated</span><time class="vp-meta-info" datetime="2025-09-02T10:49:36.000Z" data-allow-mismatch>9/2/25, 10:49 AM</time></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1093218847@qq.com">qqaazz2</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/posts/SpringSecurity_AccessDenied.html" aria-label="Spring Security å¼‚æ­¥è¸©å‘è®°ï¼šAccess Denied"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->Spring Security å¼‚æ­¥è¸©å‘è®°ï¼šAccess Denied</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">Default footer</div><div class="vp-copyright">Copyright Â© 2025 qqaazz2 </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-nNca_EMo.js" defer></script>
  </body>
</html>
